<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>零股賣價換算器 - PWA</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PWA Manifest 檔案連結 -->
    <link rel="manifest" href="manifest.json">
    <style>
        /* 使用 Inter 字體 */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        /* 自定義容器，確保內容在所有設備上置中 */
        .container { max-width: 480px; }
        /* 隱藏 Chrome/Safari 的數字輸入框箭頭 */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#007bff',
                        'secondary': '#6c757d',
                        'accent': '#28a745',
                    }
                }
            }
        }

        // PWA Manifest 內容
        const manifestContent = {
            "name": "零股賣價換算器",
            "short_name": "零股賣價",
            "description": "依照特定規則計算零股的建議賣出價格。",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#007bff",
            "icons": [
                {"src": "https://placehold.co/192x192/007bff/ffffff?text=L", "sizes": "192x192", "type": "image/png"},
                {"src": "https://placehold.co/512x512/007bff/ffffff?text=L", "sizes": "512x512", "type": "image/png"}
            ]
        };

        // 註冊 Manifest
        document.addEventListener('DOMContentLoaded', () => {
            // 1. 注入 Manifest (實現 PWA 安裝功能)
            const manifest = document.createElement('link');
            manifest.rel = 'manifest';
            manifest.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifestContent));
            document.head.appendChild(manifest);

            /* // 2. 註冊 Service Worker（用於離線快取） 
            // 由於環境限制，已移除 Service Worker 註冊，以避免 TypeError。
            */

            // 3. 綁定即時更新事件
            const inputElement = document.getElementById('purchasePrice');
            inputElement.addEventListener('input', updateCalculation);
            
            // 首次載入時執行一次計算，顯示預設值
            updateCalculation();
        });


        /**
         * 根據整股購入價格，計算零股的建議賣出價格。
         * 這是核心函式，實作了使用者提供的複雜價格區間規則。
         * @param {number} price 整股購入價格
         * @returns {number|null} 建議的零股賣出價格，如果超出範圍則為 null
         */
        function getSellingPrice(price) {
            // 確保輸入為數字
            if (isNaN(price) || price < 0.1 || price > 262.50) {
                return null; // 超出有效範圍
            }

            // 處理規則，注意範圍包含小數點的邊界條件
            let sellingPrice = 0;

            // 0.1 - 2.99 -> +0.01
            if (price >= 0.1 && price <= 2.99) {
                sellingPrice = price + 0.01;
            }
            // 3.00 - 5.64 -> +0.02
            else if (price >= 3.00 && price <= 5.64) {
                sellingPrice = price + 0.02;
            }
            // 5.65 - 8.30 -> +0.03
            else if (price >= 5.65 && price <= 8.30) {
                sellingPrice = price + 0.03;
            }
            // 8.31 - 9.96 -> +0.04
            else if (price >= 8.31 && price <= 9.96) {
                sellingPrice = price + 0.04;
            }
            // 9.97 - 9.99 -> 賣10.05 (絕對價格)
            else if (price >= 9.97 && price <= 9.99) {
                sellingPrice = 10.05;
            }
            // 10.00 - 13.60 -> +0.05
            else if (price >= 10.00 && price <= 13.60) {
                sellingPrice = price + 0.05;
            }
            // 13.65 - 26.85 -> +0.10
            else if (price >= 13.65 && price <= 26.85) {
                sellingPrice = price + 0.10;
            }
            // 26.90 - 39.95 -> +0.15
            else if (price >= 26.90 && price <= 39.95) {
                sellingPrice = price + 0.15;
            }
            // 40.00 - 49.80 -> +0.20
            else if (price >= 40.00 && price <= 49.80) {
                sellingPrice = price + 0.20;
            }
            // 49.85 - 49.90 -> 50.1 (絕對價格)
            else if (price >= 49.85 && price <= 49.90) {
                sellingPrice = 50.10;
            }
            // 49.95 -> 50.2 (絕對價格)
            else if (price === 49.95) {
                sellingPrice = 50.20;
            }
            // 50.00 - 52.70 -> +0.20
            else if (price >= 50.00 && price <= 52.70) {
                sellingPrice = price + 0.20;
            }
            // 52.80 - 79.30 -> +0.30
            else if (price >= 52.80 && price <= 79.30) {
                sellingPrice = price + 0.30;
            }
            // 79.40 - 99.50 -> +0.40
            else if (price >= 79.40 && price <= 99.50) {
                sellingPrice = price + 0.40;
            }
            // 99.60 -> 100 (絕對價格)
            else if (price === 99.60) {
                sellingPrice = 100.00;
            }
            // 99.70 - 100.00 -> 100.5 (絕對價格)
            else if (price >= 99.70 && price <= 100.00) {
                sellingPrice = 100.50;
            }
            // 100.50 - 131.00 -> +0.50
            else if (price >= 100.50 && price <= 131.00) {
                sellingPrice = price + 0.50;
            }
            // 131.50 - 262.50 -> +1.00
            else if (price >= 131.50 && price <= 262.50) {
                sellingPrice = price + 1.00;
            }

            // 使用 toFixed 避免浮點數運算誤差，並確保輸出為數字
            // 注意: 核心計算邏輯仍保留較高的精確度，確保計算正確
            return parseFloat(sellingPrice.toFixed(4));
        }

        /**
         * 處理 UI 介面的即時計算邏輯
         */
        function updateCalculation() {
            const inputElement = document.getElementById('purchasePrice');
            // 移除可能存在的非數字字符，以確保 parseFloat 正常工作
            const price = parseFloat(inputElement.value.replace(/[^0-9.]/g, ''));

            const resultDiv = document.getElementById('calculationResult');
            const errorDiv = document.getElementById('errorMsg');
            
            // 清空先前的結果
            errorDiv.classList.add('hidden');

            // 檢查輸入是否有效
            if (isNaN(price) || price <= 0) {
                // 如果輸入為空或無效，只隱藏結果，不顯示錯誤
                resultDiv.classList.add('hidden');
                return;
            }
            
            // 執行核心計算
            const sellingPrice = getSellingPrice(price);

            if (sellingPrice === null) {
                errorDiv.textContent = `輸入價格 ${price.toFixed(2)} 超出有效換算範圍 (0.10 ~ 262.50)。`;
                errorDiv.classList.remove('hidden');
                resultDiv.classList.add('hidden');
                return;
            }
            
            // 計算價格增量
            // 使用 toFixed(4) 來確保計算時的浮點數精度
            const increment = parseFloat((sellingPrice - price).toFixed(4));
            
            // 更新 UI，所有數字輸出皆使用 .toFixed(2)
            document.getElementById('displayPurchasePrice').textContent = price.toFixed(2);
            // 增量顯示為小數點後兩位
            document.getElementById('displayIncrement').textContent = (increment >= 0 ? '+' : '') + increment.toFixed(2);
            // 賣出價格顯示為小數點後兩位
            document.getElementById('displaySellingPrice').textContent = sellingPrice.toFixed(2);

            resultDiv.classList.remove('hidden');
        }

    </script>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">
    <div class="container bg-white p-6 md:p-8 shadow-xl rounded-xl w-full">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4 text-center">零股賣出價格換算</h1>
        <p class="text-sm text-center text-secondary mb-6">依據特定交易成本表計算零股的建議賣出價格。</p>
        
        <!-- 錯誤訊息區塊 -->
        <div id="errorMsg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-6 transition duration-300">
            <!-- 錯誤訊息會顯示在這裡 -->
        </div>

        <!-- 輸入區塊 -->
        <div class="space-y-4">
            <label for="purchasePrice" class="block text-lg font-medium text-gray-700 mb-2">請輸入整股購入價格 (P)：</label>
            <input 
                type="number" 
                id="purchasePrice" 
                placeholder="例如: 10.00" 
                value="10.00"
                step="0.01"
                min="0.1"
                class="w-full px-4 py-3 border-2 border-primary rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-150 text-xl font-mono"
            >
            <!-- 移除原有的按鈕，改為即時偵測輸入 -->
        </div>

        <!-- 結果顯示區塊 -->
        <div id="calculationResult" class="mt-8 pt-6 border-t border-gray-200 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">換算結果 (即時更新)</h2>
            
            <div class="bg-gray-50 p-4 rounded-lg shadow-inner space-y-3">
                
                <div class="flex justify-between items-center border-b border-gray-300 pb-2">
                    <span class="text-secondary font-semibold">整股購入價格 (P):</span>
                    <span id="displayPurchasePrice" class="text-gray-800 font-mono text-xl">0.00</span>
                </div>

                <div class="flex justify-between items-center border-b border-gray-300 pb-2">
                    <span class="text-secondary font-semibold">價格增量 (交易成本):</span>
                    <span id="displayIncrement" class="text-red-600 font-mono text-xl">+0.00</span>
                </div>
                
                <div class="flex justify-between items-center pt-2">
                    <span class="text-primary font-bold text-xl">零股建議賣出價格 (P + 增量):</span>
                    <span id="displaySellingPrice" class="text-primary font-extrabold text-2xl font-mono">0.00</span>
                </div>
            </div>
        </div>
        
        <!-- 規則說明區塊 -->
        <div class="mt-8">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">零股價格增量規則 (整股購入價 P)：</h3>
            <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-600 max-h-48 overflow-y-auto">
                <ul class="list-disc list-inside space-y-1">
                    <li>P 0.10 ~ 2.99： +0.01</li>
                    <li>P 3.00 ~ 5.64： +0.02</li>
                    <li>P 5.65 ~ 8.30： +0.03</li>
                    <li>P 8.31 ~ 9.96： +0.04</li>
                    <li>P 9.97 ~ 9.99： 賣10.05 (絕對價格)</li>
                    <li>P 10.00 ~ 13.60： +0.05</li>
                    <li>P 13.65 ~ 26.85： +0.10</li>
                    <li>P 26.90 ~ 39.95： +0.15</li>
                    <li>P 40.00 ~ 49.80： +0.20</li>
                    <li>P 49.85 ~ 49.90： 賣50.10 (絕對價格)</li>
                    <li>P 49.95： 賣50.20 (絕對價格)</li>
                    <li>P 50.00 ~ 52.70： +0.20</li>
                    <li>P 52.80 ~ 79.30： +0.30</li>
                    <li>P 79.40 ~ 99.50： +0.40</li>
                    <li>P 99.60： 賣100.00 (絕對價格)</li>
                    <li>P 99.70 ~ 100.00： 賣100.50 (絕對價格)</li>
                    <li>P 100.50 ~ 131.00： +0.50</li>
                    <li>P 131.50 ~ 262.50： +1.00</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
