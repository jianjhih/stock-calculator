<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA 股票五檔價量查詢 (GAS Proxy)</title>
    <!-- 引入 Tailwind CSS CDN 實現快速響應式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設置 Inter 字體 */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* 基礎樣式 */
        .quote-table th, .quote-table td {
            padding: 8px 4px;
            text-align: center;
        }
        .quote-table th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .buy-price { color: #dc2626; font-weight: bold; } /* 紅色 (漲) */
        .sell-price { color: #16a34a; font-weight: bold; } /* 綠色 (跌) */
        
        /* 響應式表格排版 (手機上更緊湊) */
        @media (max-width: 640px) {
            .quote-table th, .quote-table td {
                padding: 6px 2px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    <!-- 主應用程式容器 -->
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">
            股票五檔價量查詢
        </h1>

        <!-- 股號輸入區 -->
        <div class="flex flex-col sm:flex-row gap-3 mb-8">
            <input 
                type="text" 
                id="stock-id" 
                placeholder="請輸入股票代碼 (e.g., 2330)" 
                maxlength="4"
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150"
            >
            <button 
                onclick="fetchStockData()" 
                id="fetch-button"
                class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 active:scale-95 disabled:opacity-50"
            >
                查詢
            </button>
        </div>

        <!-- 訊息/載入指示器 -->
        <div id="status-message" class="text-center text-sm text-gray-500 mb-6 h-4"></div>
        
        <!-- 報價結果容器 -->
        <div id="quotes-container" class="space-y-8">
            <!-- 整股報價區 -->
            <div id="regular-container" class="border p-4 rounded-lg bg-red-50/50 shadow-sm">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">整股報價 (單位: 張)</h2>
                <div id="regular-quotes">請輸入股號並點擊查詢。</div>
            </div>

            <!-- 零股報價區 -->
            <div id="odd-lot-container" class="border p-4 rounded-lg bg-green-50/50 shadow-sm">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">零股報價 (單位: 股)</h2>
                <div id="odd-lot-quotes">請輸入股號並點擊查詢。</div>
            </div>
        </div>
    </div>

    <!-- JavaScript 邏輯 -->
    <script>
        // !! IMPORTANT: 請務必替換成您部署的 Google Apps Script Web App 網址 !!
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxT9AaZnTAgFmbCBLyA2rF430gjPhEzGSZ9IkmzOu6ma-hzV68-2u_Rx9Y8Ye0iJyrJrg/exec'; 

        const statusMessage = document.getElementById('status-message');
        const fetchButton = document.getElementById('fetch-button');
        const regularQuotesDiv = document.getElementById('regular-quotes');
        const oddLotQuotesDiv = document.getElementById('odd-lot-quotes');
        const stockInput = document.getElementById('stock-id');

        // 模擬的台積電 2330 數據 (用於預覽測試)
        const MOCK_DATA_2330 = {"status":"success","stockId":"2330","rawRegular":{"msgArray":[{"@":"2330.tw","tv":"6996","ps":"7795","pid":"9.tse.tw|15029","pz":"1415.0000","bp":"0","fv":"111","oa":"1415.0000","ob":"1410.0000","m%":"000000","^":"20251118","key":"tse_2330.tw_20251118","a":"1410.0000_1415.0000_1420.0000_1425.0000_1430.0000_","b":"1405.0000_1400.0000_1395.0000_1390.0000_1385.0000_","c":"2330","#":"13.tse.tw|2075","d":"20251118","%":"14:30:00","ch":"2330.tw","tlong":"1763447400000","ot":"14:30:00","f":"222_858_1606_1880_499_","g":"664_5673_1747_800_348_","ip":"0","mt":"000000","ov":"138432","h":"1435.0000","i":"24","it":"12","oz":"1415.0000","l":"1405.0000","n":"台積電","o":"1435.0000","p":"0","ex":"tse","s":"6996","t":"13:30:00","u":"1585.0000","v":"41949","w":"1305.0000","nf":"台灣積體電路製造股份有限公司","y":"1445.0000","z":"1405.0000","ts":"0"}],"referer":"","userDelay":5000,"rtcode":"0000","queryTime":{"sysDate":"20251118","stockInfoItem":5069,"stockInfo":93,"sessionStr":"UserSession","sysTime":"22:41:08","showChart":false,"sessionFromTime":-1,"sessionLatestTime":-1},"rtmessage":"OK","exKey":"if_tse_2330.tw_zh-tw.null","cachedAlive":40164},"rawOddLot":{"msgArray":[{"@":"2330.tw","tt":"13:30:00","ps":"-","qm%":"866416","pz":"-","tm%":"000000","q%":"09:09:56","m%":"000000","qmt":"866416","tmt":"000000","key":"tse_2330.tw_20251118","^":"20251118","a":"1420.0000_1425.0000_1430.0000_1435.0000_1440.0000_","b":"1415.0000_1410.0000_1405.0000_1400.0000_1395.0000_","c":"2330","#":"23.tse.tw|844419","qt":"09:09:56","d":"20251118","%":"13:30:00","ch":"2330.tw","tlong":"1763443800000","f":"35873_95717_20328_10396_10901_","g":"11660_129942_590395_682365_90796_","ip":"0","mt":"000000","h":"1430.0000","i":"24","it":"12","l":"1405.0000","n":"台積電","o":"1430.0000","p":"0","t%":"13:30:00","ex":"tse","s":"291","t":"13:30:00","u":"1585.0000","v":"6205367","w":"1305.0000","nf":"台灣積體電路製造股份有限公司","y":"1445.0000","z":"1420.0000","ts":"0"}],"referer":"","userDelay":5000,"rtcode":"0000","queryTime":{"sysDate":"20251118","oddInfo":1,"oddInfoItem":707,"sessionStr":"UserSession","sysTime":"17:48:03","showChart":false,"sessionFromTime":-1,"sessionLatestTime":-1},"rtmessage":"OK","exKey":"if_tse_2330.tw_zh-tw.null","cachedAlive":17625620}};


        // 允許按下 Enter 鍵觸發查詢
        stockInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                fetchStockData();
            }
        });

        /**
         * 呼叫 GAS Proxy 服務來獲取股票資料。
         */
        async function fetchStockData() {
            const stockId = stockInput.value.trim();
            if (!stockId) {
                displayMessage('請輸入有效的股票代碼！', 'text-red-500');
                return;
            }

            // 設置為 false，因為現在有實際的 GAS 網址了
            const useMockData = (false && stockId === '2330'); 

            if (useMockData) {
                displayMessage('偵測到未配置 GAS 網址，使用台積電 (2330) 模擬數據進行渲染。', 'text-orange-500');
            } 

            // 設置載入狀態
            displayMessage('正在查詢 ' + stockId + ' 的即時資料...', 'text-blue-500');
            fetchButton.disabled = true;
            regularQuotesDiv.innerHTML = '<div class="text-center py-4">載入中...</div>';
            oddLotQuotesDiv.innerHTML = '<div class="text-center py-4">載入中...</div>';

            let data;
            
            if (useMockData) {
                // 使用模擬數據
                data = MOCK_DATA_2330;
            } else {
                // 進行網路請求
                const url = `${GAS_WEB_APP_URL}?stockId=${stockId}`;
                try {
                    const response = await fetch(url);
                    data = await response.json();
                } catch (error) {
                    console.error('連線錯誤:', error);
                    displayMessage('連線錯誤，請檢查網路或 GAS 服務是否正常運行。', 'text-red-500');
                    regularQuotesDiv.innerHTML = '連線錯誤';
                    oddLotQuotesDiv.innerHTML = '連線錯誤';
                    fetchButton.disabled = false;
                    return;
                }
            }


            if (data.status === 'success') {
                // 成功獲取資料，開始解析和渲染
                const regularInfo = data.rawRegular.msgArray && data.rawRegular.msgArray[0];
                const oddLotInfo = data.rawOddLot.msgArray && data.rawOddLot.msgArray[0];
                
                if (regularInfo && oddLotInfo) {
                    displayMessage(`成功獲取 ${regularInfo.n || stockId} (${regularInfo.t || 'N/A'}) 的報價`, 'text-green-500');
                    renderQuotes(regularInfo, 'regular', regularQuotesDiv);
                    renderQuotes(oddLotInfo, 'oddLot', oddLotQuotesDiv);
                } else {
                    displayMessage(`股票代碼 ${stockId} 無法獲取有效資料，請確認代碼是否正確或 API 狀態。`, 'text-orange-500');
                    regularQuotesDiv.innerHTML = '查無資料';
                    oddLotQuotesDiv.innerHTML = '查無資料';
                }

            } else {
                // GAS 返回錯誤 (e.g., stockId missing, internal error)
                displayMessage(`查詢失敗: ${data.message || '未知錯誤'}`, 'text-red-500');
                regularQuotesDiv.innerHTML = '查詢失敗';
                oddLotQuotesDiv.innerHTML = '查詢失敗';
            }

            fetchButton.disabled = false;
        }

        /**
         * 渲染五檔價量表格。
         * @param {Object} info TWSE API 返回的 msgArray[0] 物件。
         * @param {string} type 'regular' 或 'oddLot'。
         * @param {HTMLElement} targetDiv 渲染目標 DOM 元素。
         */
        function renderQuotes(info, type, targetDiv) {
            const isRegular = type === 'regular';
            
            // **TWSE API 欄位名稱**：
            // 整股 (Regular) 使用 'b' (買價), 'g' (買量), 'a' (賣價), 'f' (賣量)
            // 零股 (OddLot) 使用 'b5p' (買價), 'b5q' (買量), 's5p' (賣價), 's5q' (賣量)
            const [bpKey, bqKey, spKey, sqKey] = isRegular 
                ? ['b', 'g', 'a', 'f'] 
                : ['b5p', 'b5q', 's5p', 's5q']; 

            // 解析分號分隔的字串為陣列
            // 注意 TWSE API 價量字串尾部有底線 '_'，split 處理後最後一個元素會是空字串，需過濾
            const buyPrices = info[bpKey] ? info[bpKey].split('_').filter(p => p) : [];
            const buyQuantities = info[bqKey] ? info[bqKey].split('_').filter(q => q) : [];
            const sellPrices = info[spKey] ? info[spKey].split('_').filter(p => p) : [];
            const sellQuantities = info[sqKey] ? info[sqKey].split('_').filter(q => q) : [];

            const count = 5; // 五檔

            let html = `
                <div class="mb-4 text-sm font-medium">
                    <p><strong>股票名稱:</strong> ${info.n || 'N/A'}</p>
                    <p><strong>最新成交價 (Z):</strong> <span class="${info.z > info.y ? 'buy-price' : (info.z < info.y ? 'sell-price' : 'text-gray-600')}">${info.z || '--'}</span></p>
                    <p><strong>昨日收盤價 (Y):</strong> ${info.y || '--'}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="quote-table w-full border border-gray-200 rounded-lg">
                        <thead>
                            <tr>
                                <th class="rounded-tl-lg">檔位</th>
                                <th class="buy-price">買價</th>
                                <th class="buy-price">買量</th>
                                <th class="sell-price">賣價</th>
                                <th class="sell-price">賣量</th>
                                <th class="rounded-tr-lg"></th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (let i = 0; i < count; i++) {
                const priceClass = isRegular ? 'text-sm' : 'text-xs';

                html += `
                    <tr class="hover:bg-gray-100/70 transition">
                        <td>${i + 1}</td>
                        <td class="buy-price ${priceClass}">${buyPrices[i] || '--'}</td>
                        <td class="buy-price ${priceClass}">${formatQuantity(buyQuantities, i, isRegular)}</td>
                        <td class="sell-price ${priceClass}">${sellPrices[i] || '--'}</td>
                        <td class="sell-price ${priceClass}">${formatQuantity(sellQuantities, i, isRegular)}</td>
                        <td></td>
                    </tr>
                `;
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            targetDiv.innerHTML = html;
        }
        
        /**
         * 格式化數量。
         * @param {Array<string>} quantities 數量陣列。
         * @param {number} index 索引。
         * @param {boolean} isRegular 是否為整股。
         * @returns {string} 格式化後的數量字串。
         */
        function formatQuantity(quantities, index, isRegular) {
            const qStr = quantities[index];
            if (!qStr || qStr === '-') return '--';
            
            const quantity = parseInt(qStr, 10);

            if (isRegular) {
                // TWSE 整股 API 返回的值是 "1/10 張"，所以除以 10 得到 "張"
                const lots = quantity / 10;
                return lots > 0 ? `${lots.toFixed(0)} 張` : '--';
            } else {
                // TWSE 零股 API 返回的值是 "股"
                return quantity > 0 ? `${quantity} 股` : '--';
            }
        }
        
        /**
         * 顯示狀態或錯誤訊息。
         * @param {string} message 訊息內容。
         * @param {string} colorClass 顏色樣式。
         */
        function displayMessage(message, colorClass) {
            statusMessage.className = `text-center text-sm mb-6 h-4 ${colorClass}`;
            statusMessage.textContent = message;
        }

        // 初始化提示
        window.onload = () => {
             displayMessage('GAS 網址已配置。請輸入股號 (e.g., 2330) 進行查詢。', 'text-gray-500');
        };

    </script>
</body>
</html>
